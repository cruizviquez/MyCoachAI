// ...existing code from your main History (copy from previous working version)